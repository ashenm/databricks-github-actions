name: Databricks Mason
description: Validate, plan, deploy, and run Databricks Assets Bundle

inputs:
  directory:
    description: Root of the bundle project folder
    required: true
    default: "."
  target:
    description: Context of bundle deployment
    required: true
  stage:
    description: Run stage of bundle deployment
    required: true
    default: plan
  image:
    description: Docker Image reference of Databricks Assets Bundle
    required: false
    default: ghcr.io/databricks/cli:latest

runs:
  using: composite
  steps:
    - name: Configure Environment
      shell: bash
      run: |
        if [ ${GITHUB_EVENT_NAME} = "pull_request" ]; then
          pip --version
          pip install --requirement ${GITHUB_ACTION_PATH}/requirements.txt
        fi

        ls --format=long ${DATABRICKS_BUNDLE_DIRECTORY}
      env:
        DATABRICKS_BUNDLE_DIRECTORY: ${{ inputs.directory }}
    - name: Validate Databricks Bundle
      shell: bash
      run: ${GITHUB_ACTION_PATH}/run.sh validate
      env:
        DATABRICKS_BUNDLE_DIRECTORY: ${{ inputs.directory }}
        DATABRICKS_BUNDLE_ENV: ${{ inputs.target }}
        DATABRICKS_BUNDLE_IMAGE_REF: ${{ inputs.image }}
    - name: Validate Databricks Bundle Policies
      if: ${{ github.event_name == 'pull_request' }}
      shell: bash
      run: |
        python3 ${GITHUB_ACTION_PATH}/validate.py \
          --directory {DATABRICKS_BUNDLE_DIRECTORY} \
          --stage ${DATABRICKS_BUNDLE_STAGE}
      env:
        DATABRICKS_BUNDLE_DIRECTORY: ${{ inputs.directory }}
        DATABRICKS_BUNDLE_STAGE: ${{ inputs.stage }}
    - name: Execute Databricks Bundle
      shell: bash
      run: ${GITHUB_ACTION_PATH}/run.sh ${DATABRICKS_BUNDLE_STAGE}
      env:
        DATABRICKS_BUNDLE_DIRECTORY: ${{ inputs.directory }}
        DATABRICKS_BUNDLE_ENV: ${{ inputs.target }}
        DATABRICKS_BUNDLE_STAGE: ${{ inputs.stage }}
        DATABRICKS_BUNDLE_IMAGE_REF: ${{ inputs.image }}
    - name: Databricks Bundle Summary
      shell: bash
      run: ${GITHUB_ACTION_PATH}/run.sh summary
      env:
        DATABRICKS_BUNDLE_DIRECTORY: ${{ inputs.directory }}
        DATABRICKS_BUNDLE_ENV: ${{ inputs.target }}
        DATABRICKS_BUNDLE_IMAGE_REF: ${{ inputs.image }}
